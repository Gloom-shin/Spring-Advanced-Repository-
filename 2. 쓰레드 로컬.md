# ìŠ¤í”„ë§ì˜ ê°•ì˜ ë¦¬ë·°ğŸ“½

> LoadMap Part : ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ ê³ ê¸‰í¸   
> Section : 2.Thread Local  
> CreateDate : 2022.11.14   
> UpdateDate : 2022.11.

### ëª©ì°¨

<br></br>

### IntelliJ ë‹¨ì¶•í‚¤

<br></br>
<br></br>

# í•„ë“œ ë™ê¸°í™” - ê°œë°œ

> íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸°ë„ë¡ êµ¬í˜„í•´ì„œ ë™ê¸°í™”ëŠ” ì„±ê³µí–ˆì§€ë§Œ, ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ëŠ” ëª¨ë“  ë©”ì„œë“œì— `TreadId`íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•´ì•¼ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤.  
> íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸°ì§€ ì•Šê³  ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì—†ì„ê¹Œ

## LogTrace ì¸í„°í˜ì´ìŠ¤

- ì¸í„°í˜ì´ìŠ¤ë¶€í„° ì‹œì‘í•˜ì—¬ ì œëŒ€ë¡œëœ ë¡œê·¸ ì¶”ì ê¸°ë¥¼ ë§Œë“¤ì–´ ë³´ì
    - ë¡œê·¸ì¶”ì ê¸°ì— í•„ìš”í•œ, begin(), end(), exception()ì´ ë“¤ì–´ê°„ë‹¤.

```java
public interface LogTrace {
    TraceStatus begin(String message);

    void end(TraceStatus status);

    void exception(TraceStatus status, Exception e);
}
```

## FieldLogTrace êµ¬í˜„ì²´

- íŒŒë¼ë¯¸í„°ë¥¼ ë„˜ê¸°ì§€ ì•Šì•„ë„ TraceIdë¥¼ ë™ê¸°í™” í•  ìˆ˜ ìˆëŠ” êµ¬í˜„ì²´ ì´ë‹¤.
    - ê¸°ì¡´ì— ë§Œë“¤ì—ˆë˜ í”„ë¡œí† íƒ€ì… HelloTraceV2ë‘ ê¸°ë³¸ ë©”ì„œë“œëŠ” ë¹„ìŠ·í•˜ë‹¤.
    - [êµ¬í˜„ì²´ FieldLogTrace ì½”ë“œ](code/advanced/trace/logtrace/FieldLogTrace.java)
- ì¶”ê°€ëœ ì½”ë“œ
   - ë³€ìˆ˜ë¡œ `TraceId`ë¥¼ ë‹´ëŠ” `traceIdHolder`ê°€ ìƒê²¼ë‹¤.
     - ì´ë¡œì¸í•´, íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì£¼ì§€ì•Šì•„ë„ ëœë‹¤.
   - `syncTraceId()` : ë™ê¸°í™” ì´ìŠˆ ì²˜ë¦¬í•´ì£¼ëŠ” ë§¤ì„œë“œ, ê¸°ì¡´êº¼ê°€ ìˆìœ¼ë©´ êµ³ì´ ìƒˆë¡œë§Œë“¤ì§€ ì•Šê³  +1 í•´ì¤€ë‹¤.
   - `releaseTraceId()` : ë™ê¸°í™” ì´ìŠˆ ì²˜ë¦¬í•´ì£¼ëŠ” ë§¤ì„œë“œ, levelì´ 1ì´ìƒì´ë©´ ì‚­ì œí•˜ì§€ì•Šê³  -1 í•´ì¤€ë‹¤. 
```java
public class FieldLogTrace implements LogTrace {
  //..ìƒëµ
    private TraceId traceIdHolder; // traceId ë™ê¸°í™”,  ë™ì‹œì„± ì´ìŠˆ ë°œìƒ

    @Override
    public TraceStatus begin(String message) {
        syncTraceId();
        TraceId traceId = traceIdHolder;
      //..ìƒëµ
    }

    private void syncTraceId() {
        if (traceIdHolder == null) {
            traceIdHolder = new TraceId();
        } else
            traceIdHolder = traceIdHolder.createNextId();
    }

    private void complete(TraceStatus status, Exception e) {
        //..ìƒëµ
        releaseTraceId(); //ì¶”ê°€
    }


    private void releaseTraceId() {
        if (traceIdHolder.isFirstLevel()) {
            traceIdHolder = null; // destroy
        } else
            traceIdHolder = traceIdHolder.createPreviousId();
    }


}
```

### í…ŒìŠ¤íŠ¸
```java
class FieldLogTraceTest {

  FieldLogTrace trace = new FieldLogTrace();

  @Test
  void begin_end_level2() {
    TraceStatus status1 = trace.begin("hello1");
    TraceStatus status2 = trace.begin("hello2");
    trace.end(status2);
    trace.end(status1);
  }

  @Test
  void begin_exception_level2() {
    TraceStatus status1 = trace.begin("hello1");
    TraceStatus status2 = trace.begin("hello2");
    trace.exception(status2, new IllegalStateException());
    trace.exception(status1, new IllegalStateException());
  }
}
```
 - í™•ì¸ ê²°ê³¼ ê¹”ë”í•˜ê²Œ ì˜ ë‚˜ì˜¨ë‹¤.

<img src="https://user-images.githubusercontent.com/104331549/201832905-aaca38e6-5ddd-4807-8bb6-c938b9647471.png">


<br>
<br>

# appì ìš©
 - [ë¡œê·¸ì¶”ì ê¸°V3 ì»¨íŠ¸ë¡¤ëŸ¬](code/advanced/app/v3/OrderControllerV3.java)
 - [ë¡œê·¸ì¶”ì ê¸°V3 ì„œë¹„ìŠ¤](code/advanced/app/v3/OrderServiceV3.java)
 - [ë¡œê·¸ì¶”ì ê¸°V3 ë¦¬í¬ì§€í† ë¦¬](code/advanced/app/v3/OrderRepositoryV3.java)
 
> í•˜ì§€ë§Œ ì´ëŸ´ ê²½ìš°, ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•œë‹¤. 


<br>
<br>

# ë™ì‹œì„± ë¬¸ì œ
 - ì‹¬ê°í•œ ë™ì‹œì„±ë¬¸ì œë¥¼ ê°€ì§€ê³ ìˆë‹¤. í˜¸ì¶œì„ ì—¬ëŸ¬ë²ˆí•´ë³´ë©´ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
 - ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í›„ ë¹ ë¥´ê²Œ í˜¸ì¶œì„ 2ë²ˆí•˜ë‹ˆ ì•„ë˜ì™€ ê°™ì´ ë‚˜ì™”ë‹¤.
<img src="https://user-images.githubusercontent.com/104331549/201837596-a10f0bde-6cb9-4eb0-9dcd-59a876399ed4.png">

 - ë‘ê°œì˜ ì“°ë ˆë“œë¥¼ ì‚¬ìš©í•´ ë¡œê·¸ ì¶”ì ê¸°ë¥¼ ì‹¤í–‰í–ˆì§€ë§Œ,
   - íŠ¸ëœì­ì…˜ IDëŠ” ë‘ê°œì˜ í˜¸ì¶œë‹¤ ë™ì¼í–ˆìœ¼ë©°, 
   - levelë„ ì¤‘ì²©ë˜ì–´ì„œ, ê¹Šì´ê°€ ì´ìƒí•˜ê²Œ ì¶œë ¥ë¨ì„ ë³¼ ìˆ˜ ìˆë‹¤. 

## ë™ì‹œì„± ë¬¸ì œ ì›ì¸
 - `FieldLogTrace` ëŠ” ì‹±ê¸€í†¤ìœ¼ë¡œ ë“±ë¡ëœ ìŠ¤í”„ë§ ë¹ˆì´ë‹¤
   - ê°ì²´ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë”± 1 ê°œë§Œ ì¡´ì¬í•œë‹¤ëŠ” ëœ»ì´ë‹¤.
 - ì´ë ‡ê²Œ í•˜ë‚˜ë§Œ ìˆëŠ” ì¸ìŠ¤í„´ìŠ¤ì˜ `FieldLogTrace.traceIdHolder` í•„ë“œë¥¼ ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•˜ê¸° ë•Œë¬¸ì— ë¬¸ì œê°€ ë°œìƒí•œë‹¤