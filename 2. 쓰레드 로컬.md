# ìŠ¤í”„ë§ì˜ ê°•ì˜ ë¦¬ë·°ğŸ“½

> LoadMap Part : ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ ê³ ê¸‰í¸   
> Section : 2.Thread Local  
> CreateDate : 2022.11.14   
> UpdateDate : 2022.11.

### ëª©ì°¨

<br></br>

### IntelliJ ë‹¨ì¶•í‚¤

<br></br>
<br></br>

# í•„ë“œ ë™ê¸°í™” - ê°œë°œ

> íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸°ë„ë¡ êµ¬í˜„í•´ì„œ ë™ê¸°í™”ëŠ” ì„±ê³µí–ˆì§€ë§Œ, ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ëŠ” ëª¨ë“  ë©”ì„œë“œì— `TreadId`íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•´ì•¼ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤.  
> íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸°ì§€ ì•Šê³  ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì—†ì„ê¹Œ

## LogTrace ì¸í„°í˜ì´ìŠ¤

- ì¸í„°í˜ì´ìŠ¤ë¶€í„° ì‹œì‘í•˜ì—¬ ì œëŒ€ë¡œëœ ë¡œê·¸ ì¶”ì ê¸°ë¥¼ ë§Œë“¤ì–´ ë³´ì
    - ë¡œê·¸ì¶”ì ê¸°ì— í•„ìš”í•œ, begin(), end(), exception()ì´ ë“¤ì–´ê°„ë‹¤.

```java
public interface LogTrace {
    TraceStatus begin(String message);

    void end(TraceStatus status);

    void exception(TraceStatus status, Exception e);
}
```

## FieldLogTrace êµ¬í˜„ì²´

- íŒŒë¼ë¯¸í„°ë¥¼ ë„˜ê¸°ì§€ ì•Šì•„ë„ TraceIdë¥¼ ë™ê¸°í™” í•  ìˆ˜ ìˆëŠ” êµ¬í˜„ì²´ ì´ë‹¤.
    - ê¸°ì¡´ì— ë§Œë“¤ì—ˆë˜ í”„ë¡œí† íƒ€ì… HelloTraceV2ë‘ ê¸°ë³¸ ë©”ì„œë“œëŠ” ë¹„ìŠ·í•˜ë‹¤.
    - [êµ¬í˜„ì²´ FieldLogTrace ì½”ë“œ](code/advanced/trace/logtrace/FieldLogTrace.java)
- ì¶”ê°€ëœ ì½”ë“œ
   - ë³€ìˆ˜ë¡œ `TraceId`ë¥¼ ë‹´ëŠ” `traceIdHolder`ê°€ ìƒê²¼ë‹¤.
     - ì´ë¡œì¸í•´, íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì£¼ì§€ì•Šì•„ë„ ëœë‹¤.
   - `syncTraceId()` : ë™ê¸°í™” ì´ìŠˆ ì²˜ë¦¬í•´ì£¼ëŠ” ë§¤ì„œë“œ, ê¸°ì¡´êº¼ê°€ ìˆìœ¼ë©´ êµ³ì´ ìƒˆë¡œë§Œë“¤ì§€ ì•Šê³  +1 í•´ì¤€ë‹¤.
   - `releaseTraceId()` : ë™ê¸°í™” ì´ìŠˆ ì²˜ë¦¬í•´ì£¼ëŠ” ë§¤ì„œë“œ, levelì´ 1ì´ìƒì´ë©´ ì‚­ì œí•˜ì§€ì•Šê³  -1 í•´ì¤€ë‹¤. 
```java
public class FieldLogTrace implements LogTrace {
  //..ìƒëµ
    private TraceId traceIdHolder; // traceId ë™ê¸°í™”,  ë™ì‹œì„± ì´ìŠˆ ë°œìƒ

    @Override
    public TraceStatus begin(String message) {
        syncTraceId();
        TraceId traceId = traceIdHolder;
      //..ìƒëµ
    }

    private void syncTraceId() {
        if (traceIdHolder == null) {
            traceIdHolder = new TraceId();
        } else
            traceIdHolder = traceIdHolder.createNextId();
    }

    private void complete(TraceStatus status, Exception e) {
        //..ìƒëµ
        releaseTraceId(); //ì¶”ê°€
    }


    private void releaseTraceId() {
        if (traceIdHolder.isFirstLevel()) {
            traceIdHolder = null; // destroy
        } else
            traceIdHolder = traceIdHolder.createPreviousId();
    }


}
```

### í…ŒìŠ¤íŠ¸
```java
class FieldLogTraceTest {

  FieldLogTrace trace = new FieldLogTrace();

  @Test
  void begin_end_level2() {
    TraceStatus status1 = trace.begin("hello1");
    TraceStatus status2 = trace.begin("hello2");
    trace.end(status2);
    trace.end(status1);
  }

  @Test
  void begin_exception_level2() {
    TraceStatus status1 = trace.begin("hello1");
    TraceStatus status2 = trace.begin("hello2");
    trace.exception(status2, new IllegalStateException());
    trace.exception(status1, new IllegalStateException());
  }
}
```
 - í™•ì¸ ê²°ê³¼ ê¹”ë”í•˜ê²Œ ì˜ ë‚˜ì˜¨ë‹¤.

<img src="https://user-images.githubusercontent.com/104331549/201832905-aaca38e6-5ddd-4807-8bb6-c938b9647471.png">


<br>
<br>

# appì ìš©